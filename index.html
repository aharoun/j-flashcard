<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Harun's 日本語 Flashcards</title>
<!-- PWA / iOS Home Screen support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="日本語 Cards">
<meta name="theme-color" content="#0f0f0f">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%23e8572a'/%3E%3Ctext x='256' y='340' font-size='280' font-family='sans-serif' font-weight='bold' fill='white' text-anchor='middle'%3E%E8%AA%9E%3C/text%3E%3C/svg%3E">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;600;700&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface-hover: #222;
    --card: #1e1e1e;
    --accent: #e8572a;
    --accent-soft: rgba(232, 87, 42, 0.15);
    --text: #e8e8e8;
    --text-dim: #888;
    --text-faint: #555;
    --green: #3ecf6a;
    --green-soft: rgba(62, 207, 106, 0.12);
    --red: #e84057;
    --red-soft: rgba(232, 64, 87, 0.12);
    --border: #2a2a2a;
    --radius: 14px;
    --card-front-bg: linear-gradient(145deg, #1e1e1e, #1a1a1a);
    --card-back-bg: linear-gradient(145deg, #1c2420, #1a1e1c);
    --overlay-bg: rgba(0,0,0,0.7);
  }

  [data-theme="light"] {
    --bg: #f5f3f0;
    --surface: #ffffff;
    --surface-hover: #f0eeeb;
    --card: #ffffff;
    --accent: #d94b1e;
    --accent-soft: rgba(217, 75, 30, 0.1);
    --text: #1a1a1a;
    --text-dim: #666;
    --text-faint: #999;
    --green: #1e8c3e;
    --green-soft: rgba(30, 140, 62, 0.08);
    --red: #c02030;
    --red-soft: rgba(192, 32, 48, 0.07);
    --border: #ddd;
    --card-front-bg: linear-gradient(145deg, #ffffff, #faf9f7);
    --card-back-bg: linear-gradient(145deg, #f0f8f2, #edf5ef);
    --overlay-bg: rgba(0,0,0,0.35);
  }

  [data-theme="light"] .level-btn.active-beginner { border-color: #1e8c3e; background: rgba(30,140,62,0.08); }
  [data-theme="light"] .level-btn.active-beginner .level-name,
  [data-theme="light"] .level-btn.active-beginner .level-count { color: #1e8c3e; }
  [data-theme="light"] .level-btn.active-intermediate { border-color: #c07820; background: rgba(192,120,32,0.08); }
  [data-theme="light"] .level-btn.active-intermediate .level-name,
  [data-theme="light"] .level-btn.active-intermediate .level-count { color: #c07820; }
  [data-theme="light"] .level-btn.active-advanced { border-color: #9040b8; background: rgba(144,64,184,0.08); }
  [data-theme="light"] .level-btn.active-advanced .level-name,
  [data-theme="light"] .level-btn.active-advanced .level-count { color: #9040b8; }

  [data-theme="light"] .badge-beginner { background: rgba(30,140,62,0.1); color: #1e8c3e; }
  [data-theme="light"] .badge-intermediate { background: rgba(192,120,32,0.1); color: #c07820; }
  [data-theme="light"] .badge-advanced { background: rgba(144,64,184,0.1); color: #9040b8; }

  [data-theme="light"] .dot-beginner { background: #1e8c3e; }
  [data-theme="light"] .dot-intermediate { background: #c07820; }
  [data-theme="light"] .dot-advanced { background: #9040b8; }

  [data-theme="light"] .form-select option { background: #fff; color: #1a1a1a; }

  [data-theme="light"] kbd { background: #eee; border-color: #ccc; }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  .app {
    max-width: 520px;
    margin: 0 auto;
    padding: 24px 20px 40px;
    padding-top: max(24px, env(safe-area-inset-top));
    padding-bottom: max(40px, env(safe-area-inset-bottom));
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ─── Header ─── */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 28px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-mark {
    width: 36px;
    height: 36px;
    background: var(--accent);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Noto Sans JP', sans-serif;
    font-weight: 700;
    font-size: 18px;
    color: white;
  }

  .logo-text {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }

  .logo-text span { color: var(--text-dim); font-weight: 400; }

  .stats-pill {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 13px;
    color: var(--text-dim);
    font-weight: 500;
  }

  .stats-pill b { color: var(--accent); }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .add-card-btn {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 20px;
    padding: 6px 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .add-card-btn:hover {
    background: var(--accent-soft);
    border-color: var(--accent);
  }

  .theme-toggle {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 50%;
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 16px;
    line-height: 1;
    padding: 0;
  }

  .theme-toggle:hover {
    border-color: #888;
    background: var(--surface-hover);
  }

  /* ─── Add Card Panel ─── */
  .add-panel-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--overlay-bg);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .add-panel {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 28px 24px;
    width: 100%;
    max-width: 440px;
    animation: slideUp 0.25s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .add-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .add-panel-title {
    font-size: 18px;
    font-weight: 700;
  }

  .add-panel-close {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
  }

  .add-panel-close:hover { color: var(--text); }

  .form-group {
    margin-bottom: 14px;
  }

  .form-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 6px;
    display: block;
  }

  .form-label-hint {
    font-weight: 400;
    text-transform: none;
    letter-spacing: 0;
    color: var(--text-faint);
    font-size: 11px;
  }

  .form-input {
    width: 100%;
    background: var(--bg);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
  }

  .form-input:focus { border-color: var(--accent); }

  .form-input.input-japanese {
    font-family: 'Noto Sans JP', 'DM Sans', sans-serif;
    font-size: 18px;
  }

  .form-input.input-romaji {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
  }

  .form-row {
    display: flex;
    gap: 10px;
  }

  .form-row .form-group { flex: 1; }

  .form-select {
    width: 100%;
    background: var(--bg);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text);
    outline: none;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
  }

  .form-select:focus { border-color: var(--accent); }

  .form-select option {
    background: var(--bg);
    color: var(--text);
  }

  .form-preview {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 16px;
    text-align: center;
  }

  .form-preview-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-faint);
    margin-bottom: 8px;
  }

  .form-preview-jp {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 2px;
  }

  .form-preview-romaji {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .form-preview-en {
    font-size: 15px;
    color: var(--text-dim);
  }

  .form-preview-audio {
    background: var(--accent-soft);
    border: 1px solid rgba(232,87,42,0.3);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.15s;
  }

  .form-preview-audio:hover {
    background: rgba(232,87,42,0.25);
  }

  .form-preview-audio svg {
    width: 16px;
    height: 16px;
    fill: var(--accent);
  }

  .form-actions {
    display: flex;
    gap: 10px;
  }

  .btn-add-save {
    flex: 1;
    background: var(--accent);
    border: none;
    border-radius: 10px;
    padding: 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .btn-add-save:hover { opacity: 0.85; }
  .btn-add-save:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-add-another {
    flex: 0.7;
    background: var(--surface-hover);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-add-another:hover { border-color: #444; }

  .form-success {
    text-align: center;
    padding: 8px;
    margin-bottom: 12px;
    background: var(--green-soft);
    border: 1px solid rgba(62,207,106,0.25);
    border-radius: 8px;
    font-size: 13px;
    color: var(--green);
    font-weight: 500;
    animation: fadeIn 0.2s ease;
  }

  .custom-count {
    font-size: 11px;
    color: var(--text-faint);
    text-align: center;
    margin-top: 12px;
  }

  .custom-count b { color: var(--accent); }

  /* ─── Mode Selector ─── */
  .mode-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
  }

  .mode-btn {
    flex: 1;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 14px 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .mode-btn:hover { border-color: #444; background: var(--surface-hover); }

  .mode-btn.active {
    border-color: var(--accent);
    background: var(--accent-soft);
  }

  .mode-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .mode-btn.active .mode-label { color: var(--accent); }

  .mode-desc {
    font-size: 13px;
    color: var(--text-faint);
    line-height: 1.3;
  }

  .mode-btn.active .mode-desc { color: var(--text); }

  .mode-arrow {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    margin: 4px 0;
    color: var(--text-faint);
  }

  .mode-btn.active .mode-arrow { color: var(--accent); }

  /* ─── Category Tabs ─── */
  .categories {
    display: flex;
    gap: 6px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding-bottom: 4px;
    scrollbar-width: none;
  }
  .categories::-webkit-scrollbar { display: none; }

  .cat-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 7px 14px;
    font-size: 12.5px;
    font-weight: 500;
    color: var(--text-dim);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }

  .cat-btn:hover { border-color: #444; }
  .cat-btn.active {
    background: var(--accent-soft);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ─── Flashcard ─── */
  .card-container {
    perspective: 1000px;
    margin-bottom: 24px;
    flex-shrink: 0;
  }

  .card {
    position: relative;
    width: 100%;
    min-height: 340px;
    cursor: pointer;
    transform-style: preserve-3d;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card.flipped { transform: rotateY(180deg); }

  .card-face {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    min-height: 340px;
    backface-visibility: hidden;
    border-radius: var(--radius);
    border: 1.5px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px 28px;
    text-align: center;
  }

  .card-front {
    background: var(--card-front-bg);
  }

  .card-back {
    background: var(--card-back-bg);
    border-color: rgba(62, 207, 106, 0.2);
    transform: rotateY(180deg);
  }

  .card-hint {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-faint);
    margin-bottom: 20px;
  }

  .card-front .card-hint { color: var(--accent); }
  .card-back .card-hint { color: var(--green); }

  .card-main {
    font-size: 28px;
    font-weight: 600;
    line-height: 1.35;
    margin-bottom: 8px;
  }

  .card-japanese {
    font-family: 'Noto Sans JP', 'DM Sans', sans-serif;
    font-size: 34px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .card-romaji {
    font-family: 'JetBrains Mono', monospace;
    font-size: 17px;
    font-weight: 400;
    color: var(--text-dim);
    letter-spacing: 0.5px;
  }

  .card-english {
    font-size: 26px;
    font-weight: 600;
  }

  .card-context {
    font-size: 13px;
    color: var(--text-dim);
    margin-top: 14px;
    line-height: 1.5;
    max-width: 320px;
  }

  .tap-hint {
    position: absolute;
    bottom: 16px;
    font-size: 11px;
    color: var(--text-faint);
    letter-spacing: 0.5px;
  }

  /* ─── Action Buttons ─── */
  .actions {
    display: flex;
    gap: 10px;
    margin-bottom: 28px;
  }

  .action-btn {
    flex: 1;
    padding: 14px;
    border-radius: 12px;
    border: 1.5px solid;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-wrong {
    background: var(--red-soft);
    border-color: rgba(232, 64, 87, 0.25);
    color: var(--red);
  }
  .btn-wrong:hover { background: rgba(232, 64, 87, 0.2); border-color: var(--red); }

  .btn-right {
    background: var(--green-soft);
    border-color: rgba(62, 207, 106, 0.25);
    color: var(--green);
  }
  .btn-right:hover { background: rgba(62, 207, 106, 0.2); border-color: var(--green); }

  .btn-skip {
    flex: 0.5;
    background: var(--surface);
    border-color: var(--border);
    color: var(--text-dim);
  }
  .btn-skip:hover { border-color: #444; }

  /* ─── Progress ─── */
  .progress-section {
    margin-top: auto;
  }

  .progress-bar-bg {
    height: 4px;
    background: var(--surface);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 4px;
    transition: width 0.4s ease;
  }

  .progress-stats {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-dim);
  }

  .progress-stats .correct { color: var(--green); }
  .progress-stats .wrong { color: var(--red); }

  /* ─── Keyboard shortcut hints ─── */
  .shortcuts {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 16px;
    font-size: 11px;
    color: var(--text-faint);
  }

  kbd {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    margin-right: 4px;
  }

  /* ─── Session complete ─── */
  .session-complete {
    text-align: center;
    padding: 48px 24px;
  }

  .session-complete h2 {
    font-size: 24px;
    margin-bottom: 8px;
  }

  .session-complete p {
    color: var(--text-dim);
    margin-bottom: 24px;
  }

  .score-display {
    font-size: 48px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 8px;
  }

  .restart-btn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 14px 32px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .restart-btn:hover { opacity: 0.85; }

  /* ─── Level Selector ─── */
  .level-selector {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
  }

  .level-btn {
    flex: 1;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 10px 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-family: 'DM Sans', sans-serif;
  }

  .level-btn:hover { border-color: #444; background: var(--surface-hover); }

  .level-name {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 2px;
  }

  .level-count {
    font-size: 11px;
    color: var(--text-faint);
  }

  .level-btn.active-beginner {
    border-color: #3ecf6a;
    background: rgba(62, 207, 106, 0.1);
  }
  .level-btn.active-beginner .level-name { color: #3ecf6a; }
  .level-btn.active-beginner .level-count { color: #3ecf6a; }

  .level-btn.active-intermediate {
    border-color: #f0a030;
    background: rgba(240, 160, 48, 0.1);
  }
  .level-btn.active-intermediate .level-name { color: #f0a030; }
  .level-btn.active-intermediate .level-count { color: #f0a030; }

  .level-btn.active-advanced {
    border-color: #c060e8;
    background: rgba(192, 96, 232, 0.1);
  }
  .level-btn.active-advanced .level-name { color: #c060e8; }
  .level-btn.active-advanced .level-count { color: #c060e8; }

  .level-btn.active-all {
    border-color: var(--accent);
    background: var(--accent-soft);
  }
  .level-btn.active-all .level-name { color: var(--accent); }
  .level-btn.active-all .level-count { color: var(--accent); }

  .level-dot {
    display: inline-block;
    width: 7px;
    height: 7px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }
  .dot-beginner { background: #3ecf6a; }
  .dot-intermediate { background: #f0a030; }
  .dot-advanced { background: #c060e8; }

  .card-level-badge {
    position: absolute;
    top: 14px;
    right: 16px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 3px 8px;
    border-radius: 6px;
  }
  .badge-beginner { background: rgba(62,207,106,0.15); color: #3ecf6a; }
  .badge-intermediate { background: rgba(240,160,48,0.15); color: #f0a030; }
  .badge-advanced { background: rgba(192,96,232,0.15); color: #c060e8; }

  /* ─── Audio Controls (standalone, below card) ─── */
  .audio-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 16px;
  }

  /* ─── Audio Button ─── */
  .audio-btn {
    background: var(--accent-soft);
    border: 1.5px solid rgba(232, 87, 42, 0.3);
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 0;
    position: relative;
    z-index: 10;
  }

  .audio-btn:hover {
    background: rgba(232, 87, 42, 0.25);
    border-color: var(--accent);
    transform: scale(1.08);
  }

  .audio-btn.speaking {
    animation: pulse-ring 0.8s ease infinite;
  }

  .audio-btn svg {
    width: 20px;
    height: 20px;
    fill: var(--accent);
  }

  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(232, 87, 42, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(232, 87, 42, 0); }
    100% { box-shadow: 0 0 0 0 rgba(232, 87, 42, 0); }
  }

  .audio-speed {
    display: flex;
    gap: 4px;
    margin-top: 8px;
  }

  .speed-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }

  .speed-btn:hover { border-color: #444; }
  .speed-btn.active {
    background: var(--accent-soft);
    border-color: var(--accent);
    color: var(--accent);
  }

  .no-tts-msg {
    font-size: 11px;
    color: var(--red);
    margin-top: 8px;
    text-align: center;
  }

  /* ─── Responsive ─── */
  @media (max-width: 480px) {
    .card-japanese { font-size: 28px; }
    .card-main { font-size: 24px; }
    .card-romaji { font-size: 15px; }
  }
</style>
</head>
<body>
<div class="app" id="app"></div>

<script>
// ─── VOCABULARY DATA (with levels) ───
// level: 1 = Beginner (survival essentials), 2 = Intermediate (daily comfort), 3 = Advanced (fluent navigation)
const vocabulary = {
  "Greetings": [
    // Beginner — absolute first things you need
    { japanese: "こんにちは", romaji: "konnichiwa", english: "Hello", level: 1 },
    { japanese: "ありがとう", romaji: "arigatou", english: "Thank you", level: 1 },
    { japanese: "すみません", romaji: "sumimasen", english: "Excuse me / Sorry", level: 1 },
    { japanese: "はい", romaji: "hai", english: "Yes", level: 1 },
    { japanese: "いいえ", romaji: "iie", english: "No", level: 1 },
    { japanese: "お願いします", romaji: "onegai shimasu", english: "Please", level: 1 },
    { japanese: "おはよう", romaji: "ohayou", english: "Good morning (casual)", level: 1 },
    // Intermediate — polite forms and social basics
    { japanese: "ありがとうございます", romaji: "arigatou gozaimasu", english: "Thank you (polite)", level: 2 },
    { japanese: "おはようございます", romaji: "ohayou gozaimasu", english: "Good morning (polite)", level: 2 },
    { japanese: "こんばんは", romaji: "konbanwa", english: "Good evening", level: 2 },
    { japanese: "さようなら", romaji: "sayounara", english: "Goodbye", level: 2 },
    { japanese: "おやすみなさい", romaji: "oyasuminasai", english: "Good night", level: 2 },
    { japanese: "お元気ですか", romaji: "ogenki desu ka", english: "How are you?", level: 2 },
    { japanese: "元気です", romaji: "genki desu", english: "I'm fine", level: 2 },
    // Advanced — cultural and formal expressions
    { japanese: "はじめまして", romaji: "hajimemashite", english: "Nice to meet you", level: 3 },
    { japanese: "よろしくお願いします", romaji: "yoroshiku onegai shimasu", english: "Please treat me well", level: 3 },
    { japanese: "いただきます", romaji: "itadakimasu", english: "Let's eat (before a meal)", level: 3 },
    { japanese: "ごちそうさまでした", romaji: "gochisousama deshita", english: "Thank you for the meal", level: 3 },
    { japanese: "お久しぶりです", romaji: "ohisashiburi desu", english: "Long time no see", level: 3 },
    { japanese: "失礼します", romaji: "shitsurei shimasu", english: "Excuse me (formal)", level: 3 },
  ],
  "Survival Words": [
    // Beginner — can't survive without these
    { japanese: "水", romaji: "mizu", english: "Water", level: 1 },
    { japanese: "トイレ", romaji: "toire", english: "Toilet / Restroom", level: 1 },
    { japanese: "駅", romaji: "eki", english: "Station", level: 1 },
    { japanese: "お金", romaji: "okane", english: "Money", level: 1 },
    { japanese: "これ", romaji: "kore", english: "This", level: 1 },
    { japanese: "いくら", romaji: "ikura", english: "How much?", level: 1 },
    { japanese: "どこ", romaji: "doko", english: "Where?", level: 1 },
    { japanese: "ここ", romaji: "koko", english: "Here", level: 1 },
    { japanese: "大丈夫", romaji: "daijoubu", english: "OK / I'm fine", level: 1 },
    // Intermediate
    { japanese: "お茶", romaji: "ocha", english: "Tea", level: 2 },
    { japanese: "コーヒー", romaji: "koohii", english: "Coffee", level: 2 },
    { japanese: "ご飯", romaji: "gohan", english: "Rice / Meal", level: 2 },
    { japanese: "電車", romaji: "densha", english: "Train", level: 2 },
    { japanese: "切符", romaji: "kippu", english: "Ticket", level: 2 },
    { japanese: "今日", romaji: "kyou", english: "Today", level: 2 },
    { japanese: "明日", romaji: "ashita", english: "Tomorrow", level: 2 },
    { japanese: "時間", romaji: "jikan", english: "Time", level: 2 },
    // Advanced
    { japanese: "昨日", romaji: "kinou", english: "Yesterday", level: 3 },
    { japanese: "天気", romaji: "tenki", english: "Weather", level: 3 },
    { japanese: "暑い", romaji: "atsui", english: "Hot", level: 3 },
    { japanese: "寒い", romaji: "samui", english: "Cold", level: 3 },
    { japanese: "傘", romaji: "kasa", english: "Umbrella", level: 3 },
    { japanese: "鍵", romaji: "kagi", english: "Key", level: 3 },
    { japanese: "財布", romaji: "saifu", english: "Wallet", level: 3 },
  ],
  "Getting Around": [
    // Beginner — essential navigation
    { japanese: "右", romaji: "migi", english: "Right", level: 1 },
    { japanese: "左", romaji: "hidari", english: "Left", level: 1 },
    { japanese: "まっすぐ", romaji: "massugu", english: "Straight ahead", level: 1 },
    { japanese: "出口", romaji: "deguchi", english: "Exit", level: 1 },
    { japanese: "入口", romaji: "iriguchi", english: "Entrance", level: 1 },
    { japanese: "タクシー", romaji: "takushii", english: "Taxi", level: 1 },
    // Intermediate
    { japanese: "地下鉄", romaji: "chikatetsu", english: "Subway", level: 2 },
    { japanese: "バス", romaji: "basu", english: "Bus", level: 2 },
    { japanese: "近い", romaji: "chikai", english: "Near / Close", level: 2 },
    { japanese: "遠い", romaji: "tooi", english: "Far", level: 2 },
    { japanese: "そこ", romaji: "soko", english: "There", level: 2 },
    { japanese: "地図", romaji: "chizu", english: "Map", level: 2 },
    { japanese: "止まる", romaji: "tomaru", english: "To stop", level: 2 },
    // Advanced
    { japanese: "交番", romaji: "kouban", english: "Police box", level: 3 },
    { japanese: "病院", romaji: "byouin", english: "Hospital", level: 3 },
    { japanese: "信号", romaji: "shingou", english: "Traffic light", level: 3 },
    { japanese: "交差点", romaji: "kousaten", english: "Intersection", level: 3 },
    { japanese: "歩く", romaji: "aruku", english: "To walk", level: 3 },
    { japanese: "乗り換え", romaji: "norikae", english: "Transfer (trains)", level: 3 },
    { japanese: "片道", romaji: "katamichi", english: "One way", level: 3 },
    { japanese: "往復", romaji: "oufuku", english: "Round trip", level: 3 },
  ],
  "Shopping & Food": [
    // Beginner — ordering and paying
    { japanese: "いくらですか", romaji: "ikura desu ka", english: "How much is it?", level: 1 },
    { japanese: "これをください", romaji: "kore o kudasai", english: "This one, please", level: 1 },
    { japanese: "おいしい", romaji: "oishii", english: "Delicious", level: 1 },
    { japanese: "メニュー", romaji: "menyuu", english: "Menu", level: 1 },
    { japanese: "会計", romaji: "kaikei", english: "Check / Bill", level: 1 },
    // Intermediate
    { japanese: "それ", romaji: "sore", english: "That (near you)", level: 2 },
    { japanese: "高い", romaji: "takai", english: "Expensive", level: 2 },
    { japanese: "安い", romaji: "yasui", english: "Cheap", level: 2 },
    { japanese: "大きい", romaji: "ookii", english: "Big", level: 2 },
    { japanese: "小さい", romaji: "chiisai", english: "Small", level: 2 },
    { japanese: "現金", romaji: "genkin", english: "Cash", level: 2 },
    { japanese: "クレジットカード", romaji: "kurejitto kaado", english: "Credit card", level: 2 },
    { japanese: "レシート", romaji: "reshiito", english: "Receipt", level: 2 },
    // Advanced
    { japanese: "袋", romaji: "fukuro", english: "Bag", level: 3 },
    { japanese: "肉", romaji: "niku", english: "Meat", level: 3 },
    { japanese: "魚", romaji: "sakana", english: "Fish", level: 3 },
    { japanese: "野菜", romaji: "yasai", english: "Vegetables", level: 3 },
    { japanese: "飲み物", romaji: "nomimono", english: "Drink / Beverage", level: 3 },
    { japanese: "辛い", romaji: "karai", english: "Spicy", level: 3 },
    { japanese: "甘い", romaji: "amai", english: "Sweet", level: 3 },
    { japanese: "お持ち帰り", romaji: "omochikaeri", english: "Takeout", level: 3 },
    { japanese: "アレルギー", romaji: "arerugii", english: "Allergy", level: 3 },
  ],
  "Key Phrases": [
    // Beginner — absolute must-know phrases
    { japanese: "わかりません", romaji: "wakarimasen", english: "I don't understand", level: 1 },
    { japanese: "日本語がわかりません", romaji: "nihongo ga wakarimasen", english: "I don't understand Japanese", level: 1 },
    { japanese: "英語を話せますか", romaji: "eigo o hanasemasu ka", english: "Do you speak English?", level: 1 },
    { japanese: "助けて", romaji: "tasukete", english: "Help!", level: 1 },
    { japanese: "ちょっと待って", romaji: "chotto matte", english: "Wait a moment", level: 1 },
    // Intermediate
    { japanese: "もう一度お願いします", romaji: "mou ichido onegai shimasu", english: "One more time, please", level: 2 },
    { japanese: "ゆっくりお願いします", romaji: "yukkuri onegai shimasu", english: "Slowly, please", level: 2 },
    { japanese: "これは何ですか", romaji: "kore wa nan desu ka", english: "What is this?", level: 2 },
    { japanese: "大丈夫です", romaji: "daijoubu desu", english: "It's okay / I'm fine", level: 2 },
    { japanese: "わかりました", romaji: "wakarimashita", english: "I understand / Got it", level: 2 },
    { japanese: "お手洗いはどこですか", romaji: "otearai wa doko desu ka", english: "Where is the restroom?", level: 2 },
    // Advanced
    { japanese: "予約があります", romaji: "yoyaku ga arimasu", english: "I have a reservation", level: 3 },
    { japanese: "写真を撮ってもいいですか", romaji: "shashin o tottemo ii desu ka", english: "May I take a photo?", level: 3 },
    { japanese: "WiFiはありますか", romaji: "waifai wa arimasu ka", english: "Is there WiFi?", level: 3 },
    { japanese: "少し日本語を話します", romaji: "sukoshi nihongo o hanashimasu", english: "I speak a little Japanese", level: 3 },
    { japanese: "何時ですか", romaji: "nanji desu ka", english: "What time is it?", level: 3 },
    { japanese: "どうやって行きますか", romaji: "douyatte ikimasu ka", english: "How do I get there?", level: 3 },
    { japanese: "具合が悪いです", romaji: "guai ga warui desu", english: "I'm not feeling well", level: 3 },
    { japanese: "道に迷いました", romaji: "michi ni mayoimashita", english: "I'm lost", level: 3 },
  ],
  "Numbers": [
    // Beginner — 1-10
    { japanese: "一", romaji: "ichi", english: "One (1)", level: 1 },
    { japanese: "二", romaji: "ni", english: "Two (2)", level: 1 },
    { japanese: "三", romaji: "san", english: "Three (3)", level: 1 },
    { japanese: "四", romaji: "yon", english: "Four (4)", level: 1 },
    { japanese: "五", romaji: "go", english: "Five (5)", level: 1 },
    { japanese: "六", romaji: "roku", english: "Six (6)", level: 1 },
    { japanese: "七", romaji: "nana", english: "Seven (7)", level: 1 },
    { japanese: "八", romaji: "hachi", english: "Eight (8)", level: 1 },
    { japanese: "九", romaji: "kyuu", english: "Nine (9)", level: 1 },
    { japanese: "十", romaji: "juu", english: "Ten (10)", level: 1 },
    // Intermediate — larger numbers, currency
    { japanese: "百", romaji: "hyaku", english: "Hundred (100)", level: 2 },
    { japanese: "千", romaji: "sen", english: "Thousand (1,000)", level: 2 },
    { japanese: "万", romaji: "man", english: "Ten thousand (10,000)", level: 2 },
    { japanese: "円", romaji: "en", english: "Yen (currency)", level: 2 },
    { japanese: "零", romaji: "rei / zero", english: "Zero (0)", level: 2 },
    // Advanced — counters
    { japanese: "一つ", romaji: "hitotsu", english: "One (general counter)", level: 3 },
    { japanese: "二つ", romaji: "futatsu", english: "Two (general counter)", level: 3 },
    { japanese: "三つ", romaji: "mittsu", english: "Three (general counter)", level: 3 },
    { japanese: "一人", romaji: "hitori", english: "One person", level: 3 },
    { japanese: "二人", romaji: "futari", english: "Two people", level: 3 },
  ],
  "People & Pronouns": [
    // Beginner
    { japanese: "私", romaji: "watashi", english: "I / Me", level: 1 },
    { japanese: "あなた", romaji: "anata", english: "You", level: 1 },
    { japanese: "友達", romaji: "tomodachi", english: "Friend", level: 1 },
    // Intermediate
    { japanese: "彼", romaji: "kare", english: "He / Him", level: 2 },
    { japanese: "彼女", romaji: "kanojo", english: "She / Her", level: 2 },
    { japanese: "私たち", romaji: "watashitachi", english: "We / Us", level: 2 },
    { japanese: "名前", romaji: "namae", english: "Name", level: 2 },
    { japanese: "先生", romaji: "sensei", english: "Teacher / Professor", level: 2 },
    { japanese: "学生", romaji: "gakusei", english: "Student", level: 2 },
    // Advanced
    { japanese: "家族", romaji: "kazoku", english: "Family", level: 3 },
    { japanese: "子供", romaji: "kodomo", english: "Child / Children", level: 3 },
    { japanese: "大人", romaji: "otona", english: "Adult", level: 3 },
    { japanese: "お兄さん", romaji: "oniisan", english: "Older brother", level: 3 },
    { japanese: "お姉さん", romaji: "oneesan", english: "Older sister", level: 3 },
    { japanese: "同僚", romaji: "douryou", english: "Colleague", level: 3 },
  ],
};

const LEVELS = {
  all: { label: 'All Levels', colorClass: 'active-all' },
  1: { label: 'Beginner', colorClass: 'active-beginner', dot: 'dot-beginner', badge: 'badge-beginner' },
  2: { label: 'Intermediate', colorClass: 'active-intermediate', dot: 'dot-intermediate', badge: 'badge-intermediate' },
  3: { label: 'Advanced', colorClass: 'active-advanced', dot: 'dot-advanced', badge: 'badge-advanced' },
};

// ─── CUSTOM CARDS (localStorage) ───
function loadCustomCards() {
  try {
    const stored = localStorage.getItem('jp_flashcards_custom');
    return stored ? JSON.parse(stored) : [];
  } catch(e) { return []; }
}

function saveCustomCards(cards) {
  try {
    localStorage.setItem('jp_flashcards_custom', JSON.stringify(cards));
  } catch(e) {}
}

function addCustomCard(card) {
  const customs = loadCustomCards();
  customs.push(card);
  saveCustomCards(customs);
  mergeCustomCards();
}

function mergeCustomCards() {
  // Remove previously merged custom cards (tagged with custom: true)
  for (const cat in vocabulary) {
    vocabulary[cat] = vocabulary[cat].filter(c => !c.custom);
  }
  // Re-merge from storage
  const customs = loadCustomCards();
  customs.forEach(card => {
    const cat = card.category || 'My Words';
    if (!vocabulary[cat]) vocabulary[cat] = [];
    vocabulary[cat].push({ ...card, custom: true });
  });
}

function getCustomCardCount() {
  return loadCustomCards().length;
}

// ─── ADD PANEL STATE ───
let addPanelOpen = false;
let addFormSuccess = false;

function openAddPanel() {
  addPanelOpen = true;
  addFormSuccess = false;
  render();
  // Focus first input after render
  setTimeout(() => {
    const inp = document.getElementById('input-japanese');
    if (inp) inp.focus();
  }, 100);
}

function closeAddPanel() {
  addPanelOpen = false;
  render();
}

function previewCustomAudio() {
  const jp = document.getElementById('input-japanese');
  if (jp && jp.value.trim()) speak(jp.value.trim());
}

function saveNewCard() {
  const jp = document.getElementById('input-japanese').value.trim();
  const rm = document.getElementById('input-romaji').value.trim();
  const en = document.getElementById('input-english').value.trim();
  const cat = document.getElementById('select-category').value;
  const lvl = parseInt(document.getElementById('select-level').value);

  if (!jp || !rm || !en) return;

  addCustomCard({
    japanese: jp,
    romaji: rm,
    english: en,
    category: cat,
    level: lvl,
  });

  addFormSuccess = true;
  render();
  // Keep panel open, clear fields for adding another
  setTimeout(() => {
    const inp = document.getElementById('input-japanese');
    if (inp) {
      document.getElementById('input-japanese').value = '';
      document.getElementById('input-romaji').value = '';
      document.getElementById('input-english').value = '';
      inp.focus();
    }
    addFormSuccess = false;
    render();
  }, 1500);
}

function renderAddPanel() {
  if (!addPanelOpen) return '';

  const allCategories = Object.keys(vocabulary);

  return `
    <div class="add-panel-overlay" onclick="if(event.target===this)closeAddPanel()">
      <div class="add-panel">
        <div class="add-panel-header">
          <div class="add-panel-title">Add New Card</div>
          <button class="add-panel-close" onclick="closeAddPanel()">&times;</button>
        </div>

        ${addFormSuccess ? '<div class="form-success">Card added successfully!</div>' : ''}

        <div class="form-group">
          <label class="form-label">Japanese <span class="form-label-hint">— hiragana, katakana, or kanji</span></label>
          <input type="text" id="input-japanese" class="form-input input-japanese" placeholder="こんにちは" oninput="updateAddPreview()">
        </div>

        <div class="form-group">
          <label class="form-label">Romaji <span class="form-label-hint">— romanized pronunciation</span></label>
          <input type="text" id="input-romaji" class="form-input input-romaji" placeholder="konnichiwa" oninput="updateAddPreview()">
        </div>

        <div class="form-group">
          <label class="form-label">English <span class="form-label-hint">— meaning / translation</span></label>
          <input type="text" id="input-english" class="form-input" placeholder="Hello" oninput="updateAddPreview()">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="select-category" class="form-select">
              ${allCategories.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('')}
              ${!allCategories.includes('My Words') ? '<option value="My Words">My Words</option>' : ''}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Level</label>
            <select id="select-level" class="form-select">
              <option value="1">Beginner</option>
              <option value="2">Intermediate</option>
              <option value="3">Advanced</option>
            </select>
          </div>
        </div>

        <div class="form-preview" id="add-preview">
          <div class="form-preview-label">Preview</div>
          <div class="form-preview-jp" id="preview-jp">—</div>
          <div class="form-preview-romaji" id="preview-rm">—</div>
          <div class="form-preview-en" id="preview-en">—</div>
          <button class="form-preview-audio" onclick="previewCustomAudio()" title="Test pronunciation">
            <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
          </button>
        </div>

        <div class="form-actions">
          <button class="btn-add-save" onclick="saveNewCard()">Add Card</button>
        </div>

        <div class="custom-count">
          <b>${getCustomCardCount()}</b> custom card${getCustomCardCount() !== 1 ? 's' : ''} added
        </div>
      </div>
    </div>
  `;
}

function updateAddPreview() {
  const jp = document.getElementById('input-japanese');
  const rm = document.getElementById('input-romaji');
  const en = document.getElementById('input-english');
  if (!jp) return;
  const pjp = document.getElementById('preview-jp');
  const prm = document.getElementById('preview-rm');
  const pen = document.getElementById('preview-en');
  if (pjp) pjp.textContent = jp.value || '—';
  if (prm) prm.textContent = rm.value || '—';
  if (pen) pen.textContent = en.value || '—';
}

// Load custom cards on startup
mergeCustomCards();

// ─── THEME TOGGLE ───
function getTheme() {
  try { return localStorage.getItem('jp_flashcards_theme') || 'dark'; } catch(e) { return 'dark'; }
}
function setTheme(theme) {
  try { localStorage.setItem('jp_flashcards_theme', theme); } catch(e) {}
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
}
function toggleTheme() {
  const next = getTheme() === 'dark' ? 'light' : 'dark';
  setTheme(next);
  render();
}
// Apply saved theme on load
setTheme(getTheme());

// ─── SPEECH SYNTHESIS ───
let speechRate = 0.75; // default to slow
let isSpeaking = false;

function speak(text) {
  if (!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'ja-JP';
  utterance.rate = speechRate;
  utterance.pitch = 1;

  // Try to find a Japanese voice
  const voices = window.speechSynthesis.getVoices();
  const jpVoice = voices.find(v => v.lang.startsWith('ja'));
  if (jpVoice) utterance.voice = jpVoice;

  utterance.onstart = () => { isSpeaking = true; updateAudioBtn(); };
  utterance.onend = () => { isSpeaking = false; updateAudioBtn(); };
  utterance.onerror = () => { isSpeaking = false; updateAudioBtn(); };

  window.speechSynthesis.speak(utterance);
}

function updateAudioBtn() {
  const btn = document.getElementById('audio-btn');
  if (btn) {
    btn.classList.toggle('speaking', isSpeaking);
  }
}

function setSpeed(rate) {
  speechRate = rate;
  render();
  // Re-speak at new speed only if Japanese is currently visible
  const japaneseVisible = state.mode === 'jp-to-en' || state.flipped;
  if (japaneseVisible) {
    const card = state.cards[state.currentIndex];
    if (card) speak(card.japanese);
  }
}

function handleAudioClick(e) {
  e.stopPropagation(); // don't flip the card
  const card = state.cards[state.currentIndex];
  if (card) speak(card.japanese);
}

// Load voices (they load async on some browsers)
if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = () => {};
  // Trigger voice loading
  window.speechSynthesis.getVoices();
}

function audioButtonHTML() {
  const hasTTS = 'speechSynthesis' in window;
  if (!hasTTS) {
    return '<div class="no-tts-msg">Audio not supported in this browser</div>';
  }
  return `
    <button class="audio-btn ${isSpeaking ? 'speaking' : ''}" id="audio-btn" onclick="handleAudioClick(event)" title="Play pronunciation">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
      </svg>
    </button>
    <div class="audio-speed">
      <button class="speed-btn ${speechRate === 0.5 ? 'active' : ''}" onclick="event.stopPropagation(); setSpeed(0.5)">0.5×</button>
      <button class="speed-btn ${speechRate === 0.75 ? 'active' : ''}" onclick="event.stopPropagation(); setSpeed(0.75)">0.75×</button>
      <button class="speed-btn ${speechRate === 1 ? 'active' : ''}" onclick="event.stopPropagation(); setSpeed(1)">1×</button>
    </div>
  `;
}

// ─── HTML ESCAPING ───
function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ─── APP STATE ───
let state = {
  mode: 'en-to-jp',
  category: 'All',
  level: 'all',              // 'all', 1, 2, 3
  currentIndex: 0,
  flipped: false,
  correct: 0,
  wrong: 0,
  skipped: 0,
  cards: [],
  sessionDone: false,
};

function getCards(category, level) {
  let cards;
  if (category === 'All') {
    cards = Object.values(vocabulary).flat();
  } else {
    cards = [...(vocabulary[category] || [])];
  }
  // Filter by level
  if (level !== 'all') {
    cards = cards.filter(c => c.level === level);
  }
  // Shuffle
  for (let i = cards.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [cards[i], cards[j]] = [cards[j], cards[i]];
  }
  return cards;
}

function countByLevel(category, level) {
  let cards;
  if (category === 'All') {
    cards = Object.values(vocabulary).flat();
  } else {
    cards = vocabulary[category] || [];
  }
  if (level === 'all') return cards.length;
  return cards.filter(c => c.level === level).length;
}

function startSession() {
  state.cards = getCards(state.category, state.level);
  state.currentIndex = 0;
  state.flipped = false;
  state.correct = 0;
  state.wrong = 0;
  state.skipped = 0;
  state.sessionDone = false;
  render();
}

function flipCard() {
  if (state.sessionDone) return;
  state.flipped = !state.flipped;
  render();
}

function markCorrect() {
  state.correct++;
  nextCard();
}

function markWrong() {
  state.wrong++;
  nextCard();
}

function skipCard() {
  state.skipped++;
  nextCard();
}

function nextCard() {
  state.flipped = false;
  if (state.currentIndex + 1 >= state.cards.length) {
    state.sessionDone = true;
  } else {
    state.currentIndex++;
  }
  render();
}

function setMode(mode) {
  state.mode = mode;
  startSession();
}

function setCategory(cat) {
  state.category = cat;
  startSession();
}

function setLevel(level) {
  state.level = level;
  startSession();
}

// ─── RENDER ───
function render() {
  const app = document.getElementById('app');
  const card = state.cards[state.currentIndex];
  const total = state.cards.length;
  const reviewed = state.correct + state.wrong + state.skipped;
  const progress = total > 0 ? (reviewed / total) * 100 : 0;
  const categories = ['All', ...Object.keys(vocabulary)];

  let cardHTML = '';

  if (state.sessionDone) {
    const pct = total > 0 ? Math.round((state.correct / (state.correct + state.wrong)) * 100) : 0;
    cardHTML = `
      <div class="session-complete">
        <div class="score-display">${isNaN(pct) ? '—' : pct + '%'}</div>
        <h2>Session Complete</h2>
        <p>${state.correct} correct · ${state.wrong} wrong · ${state.skipped} skipped · ${total} total</p>
        <button class="restart-btn" onclick="startSession()">Go Again</button>
      </div>
    `;
  } else if (card) {
    // Build front and back based on mode
    let frontHTML, backHTML;

    if (state.mode === 'en-to-jp') {
      // FRONT: English only
      frontHTML = `
        <span class="card-level-badge ${LEVELS[card.level].badge}">${LEVELS[card.level].label}</span>
        <div class="card-hint">English</div>
        <div class="card-main card-english">${esc(card.english)}</div>
        <div class="tap-hint">tap to reveal Japanese</div>
      `;
      // BACK: Japanese + Romaji
      backHTML = `
        <span class="card-level-badge ${LEVELS[card.level].badge}">${LEVELS[card.level].label}</span>
        <div class="card-hint">Japanese</div>
        <div class="card-japanese">${esc(card.japanese)}</div>
        <div class="card-romaji">${esc(card.romaji)}</div>
      `;
    } else {
      // FRONT: Japanese + Romaji
      frontHTML = `
        <span class="card-level-badge ${LEVELS[card.level].badge}">${LEVELS[card.level].label}</span>
        <div class="card-hint">Japanese</div>
        <div class="card-japanese">${esc(card.japanese)}</div>
        <div class="card-romaji">${esc(card.romaji)}</div>
        <div class="tap-hint">tap to reveal English</div>
      `;
      // BACK: English only
      backHTML = `
        <span class="card-level-badge ${LEVELS[card.level].badge}">${LEVELS[card.level].label}</span>
        <div class="card-hint">English</div>
        <div class="card-main card-english">${esc(card.english)}</div>
      `;
    }

    cardHTML = `
      <div class="card-container">
        <div class="card ${state.flipped ? 'flipped' : ''}" onclick="flipCard()">
          <div class="card-face card-front">${frontHTML}</div>
          <div class="card-face card-back">${backHTML}</div>
        </div>
      </div>
      <div class="audio-controls">
        ${state.mode === 'jp-to-en' || state.flipped ? audioButtonHTML() : '<div style="height:44px"></div>'}
      </div>
      <div class="actions">
        <button class="action-btn btn-wrong" onclick="markWrong()">✕ Wrong</button>
        <button class="action-btn btn-skip" onclick="skipCard()">Skip</button>
        <button class="action-btn btn-right" onclick="markCorrect()">✓ Got it</button>
      </div>
    `;
  } else {
    // No cards match current filters
    cardHTML = `
      <div class="session-complete">
        <h2>No cards found</h2>
        <p>This category doesn't have cards at this level.<br>Try a different combination.</p>
        <button class="restart-btn" onclick="setLevel('all')">Show All Levels</button>
      </div>
    `;
  }

  app.innerHTML = `
    <div class="header">
      <div class="logo">
        <div class="logo-mark">語</div>
        <div class="logo-text">Harun's <span>日本語</span></div>
      </div>
      <div class="header-actions">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">${getTheme() === 'dark' ? '☀️' : '🌙'}</button>
        <button class="add-card-btn" onclick="openAddPanel()">＋ Add</button>
        <div class="stats-pill"><b>${reviewed}</b> / ${total}</div>
      </div>
    </div>

    <div class="mode-selector">
      <div class="mode-btn ${state.mode === 'en-to-jp' ? 'active' : ''}" onclick="setMode('en-to-jp')">
        <div class="mode-label">Mode A</div>
        <div class="mode-arrow">EN → JP</div>
        <div class="mode-desc">See English, guess Japanese</div>
      </div>
      <div class="mode-btn ${state.mode === 'jp-to-en' ? 'active' : ''}" onclick="setMode('jp-to-en')">
        <div class="mode-label">Mode B</div>
        <div class="mode-arrow">JP → EN</div>
        <div class="mode-desc">See Japanese, guess English</div>
      </div>
    </div>

    <div class="level-selector">
      <div class="level-btn ${state.level === 'all' ? LEVELS.all.colorClass : ''}" onclick="setLevel('all')">
        <div class="level-name">All</div>
        <div class="level-count">${countByLevel(state.category, 'all')} cards</div>
      </div>
      <div class="level-btn ${state.level === 1 ? LEVELS[1].colorClass : ''}" onclick="setLevel(1)">
        <div class="level-name"><span class="level-dot dot-beginner"></span>Beginner</div>
        <div class="level-count">${countByLevel(state.category, 1)} cards</div>
      </div>
      <div class="level-btn ${state.level === 2 ? LEVELS[2].colorClass : ''}" onclick="setLevel(2)">
        <div class="level-name"><span class="level-dot dot-intermediate"></span>Intermediate</div>
        <div class="level-count">${countByLevel(state.category, 2)} cards</div>
      </div>
      <div class="level-btn ${state.level === 3 ? LEVELS[3].colorClass : ''}" onclick="setLevel(3)">
        <div class="level-name"><span class="level-dot dot-advanced"></span>Advanced</div>
        <div class="level-count">${countByLevel(state.category, 3)} cards</div>
      </div>
    </div>

    <div class="categories">
      ${categories.map(c => {
        const safeAttr = esc(c).replace(/'/g, '&#39;');
        return `<div class="cat-btn ${state.category === c ? 'active' : ''}" onclick="setCategory('${safeAttr}')">${esc(c)}</div>`;
      }).join('')}
    </div>

    ${cardHTML}

    <div class="progress-section">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" style="width: ${progress}%"></div>
      </div>
      <div class="progress-stats">
        <span class="correct">✓ ${state.correct}</span>
        <span>${state.skipped} skipped</span>
        <span class="wrong">✕ ${state.wrong}</span>
      </div>
    </div>

    <div class="shortcuts">
      <span><kbd>Space</kbd> flip</span>
      <span><kbd>←</kbd> wrong</span>
      <span><kbd>→</kbd> got it</span>
      <span><kbd>↓</kbd> skip</span>
      <span><kbd>P</kbd> play audio</span>
    </div>
  `;

  // Append add-card panel overlay (outside main flow)
  const panelHTML = renderAddPanel();
  if (panelHTML) {
    app.insertAdjacentHTML('beforeend', panelHTML);
  }
}

// ─── KEYBOARD SHORTCUTS ───
document.addEventListener('keydown', (e) => {
  // Close add panel on Escape
  if (e.code === 'Escape' && addPanelOpen) {
    closeAddPanel();
    return;
  }
  // Don't trigger shortcuts when typing in form inputs
  if (addPanelOpen) return;
  if (state.sessionDone) return;
  if (e.code === 'Space') { e.preventDefault(); flipCard(); }
  if (e.code === 'ArrowRight') { markCorrect(); }
  if (e.code === 'ArrowLeft') { markWrong(); }
  if (e.code === 'ArrowDown') { e.preventDefault(); skipCard(); }
  if (e.code === 'KeyP' || e.code === 'KeyA') {
    const japaneseVisible = state.mode === 'jp-to-en' || state.flipped;
    if (japaneseVisible) {
      const card = state.cards[state.currentIndex];
      if (card) speak(card.japanese);
    }
  }
});

// ─── SERVICE WORKER (PWA offline support) ───
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// ─── INIT ───
startSession();
</script>
</body>
</html>
